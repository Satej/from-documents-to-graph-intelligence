version: '3.8'

services:
  # Neo4j graph database with GenAI plugin enabled.  It stores the knowledge graph and embeddings.
  neo4j:
    image: neo4j:5.14
    container_name: neo4j
    environment:
      # Set default user/password.  Change the password for production use.
      - NEO4J_AUTH=neo4j/neo4jpass
      # Enable GenAI and Graph Data Science plugins for vector encoding and algorithms.
      - NEO4J_PLUGINS=["graph-data-science"]
      # Accept the Neo4j license terms automatically.
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
    ports:
      - "7474:7474"      # Neo4j Browser HTTP
      - "7687:7687"      # Bolt protocol
    volumes:
      - neo4j-data:/data   # Persist the database across restarts
      - neo4j-logs:/logs   # Persist logs

  # Example service for running the D2GEP pipeline.  It has Python and all dependencies.
  pipeline:
    image: python:3.11-slim
    container_name: d2gep-pipeline
    depends_on:
      - neo4j
      - ollama
    environment:
      # Configuration for the Ollama LLM.  Override these variables if you run
      # Ollama on a different host or wish to use a different model.
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=llama2
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=neo4jpass
    volumes:
      - ./pipeline:/app
    working_dir: /app
    # Install pipeline dependencies when the container starts, then run your script
    command: >
      bash -c "pip install --no-cache-dir langchain langchain-community langchain-text-splitters langchain-experimental neo4j
      sentence-transformers spacy faiss-cpu && python -m spacy download en_core_web_sm && python pipeline.py"
    ports:
      - "8888:8888"      # If you run a Jupyter notebook inside the pipeline service

  # Ollama service providing a local LLM.  This container listens on
  # port 11434 and hosts models that can be used by the pipeline via HTTP.
  ollama:
    image: ollama/ollama
    container_name: ollama
    ports:
      - "11434:11434"

volumes:
  neo4j-data:
  neo4j-logs:
